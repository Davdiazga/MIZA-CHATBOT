import React, { useState } from "react";

// Colores del tema Blue Glass (Minimalista)
const BLUE_ACCENT = "#3572E2"; // Un azul vibrante y moderno

function speak(text) {
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = "es-CO";
  msg.pitch = 1;
  msg.rate = 1;
  window.speechSynthesis.speak(msg);
}
// --- FUNCIÃ“N PARA CONSULTAR A LA IA (GEMINI) ---
async function getAIResponse(prompt, userName, visitedPlaces) {
  try {
    const placesInfo = visitedPlaces && visitedPlaces.length > 0
      ? `El usuario ya ha visitado o conoce estos lugares: ${visitedPlaces.join(", ")}. No recomiendes estos lugares.`
      : "";

    const userGreeting = userName ? `El usuario se llama ${userName}. ` : "";
    
    // Enviar solo la informaciÃ³n esencial al servidor
    const fullPrompt = `${userGreeting}${placesInfo}\n\nPregunta: ${prompt}`;

    const response = await fetch("http://localhost:3001/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: fullPrompt })
    });

    if (!response.ok) {
      console.log("âŒ Error en el servidor:", response.status);
      return "âš ï¸ El servidor no respondiÃ³ correctamente.";
    }

    const data = await response.json();

    // Validar si existe respuesta
    if (!data || !data.reply) {
      return "ğŸ˜• No hubo respuesta del modelo.";
    }

    return data.reply;
  } catch (error) {
    console.log("Error al conectar:", error);
    return "ğŸš« No pude conectarme al servidor.";
  }
}

export default function App() {
  const [messages, setMessages] = useState([
    { from: "bot", text: "ğŸŒŸ Â¡Hola! Soy MIZA, tu guÃ­a turÃ­stico virtual de Manizales. Puedo recomendarte lugares, comidas, rutas y clima â˜•ï¸ğŸï¸" }
  ]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [typingText, setTypingText] = useState("");
  const [darkMode, setDarkMode] = useState(false);
  const [userName, setUserName] = useState("");
  const [visitedPlaces, setVisitedPlaces] = useState([]);

  const handleSend = async (customPrompt) => {
    const text = customPrompt || input;
    if (!text.trim()) return;

    // Detectar si el usuario menciona su nombre (ej: "Me llamo Juan", "Soy MarÃ­a")
    const nameMatch = text.match(/(?:me llamo|soy|mi nombre es)\s+(\w+)/i);
    const detectedName = nameMatch?.[1];

    // Prepare el nombre que se usarÃ¡ ahora (no confiar en el setState inmediato)
    const currentName = userName || detectedName || "";
    if (detectedName && !userName) {
      setUserName(detectedName);
    }

    // Detectar lugares visitados mencionados (palabras clave: "visitÃ©", "estuve en", "ya conocÃ­")
    const placeMatch = text.match(/(?:visitÃ©|estuve en|ya conocÃ­|ya visitÃ©|fui a|conozco)\s+([a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)(?:\.|,|$)/i);
    let newVisited = [...visitedPlaces];
    if (placeMatch) {
      const place = placeMatch[1].trim();
      if (!newVisited.includes(place)) {
        newVisited.push(place);
        setVisitedPlaces(newVisited);
      }
    }

    const newMessages = [...messages, { from: "user", text }];
    setMessages(newMessages);
    setInput("");
    setLoading(true);
    setTypingText("âœï¸ MIZA estÃ¡ escribiendo...");

    // Pasar la informaciÃ³n actualizada al prompt (nombre + lugares visitados)
    const reply = await getAIResponse(text, currentName, newVisited);
    const safeReply = reply || "ğŸ˜• No hubo respuesta.";
    setTypingText("");

  
   

    let typed = "";
    for (let char of safeReply) {
      typed += char;
      setTypingText(typed);
      await new Promise((res) => setTimeout(res, 25));
    }

    setMessages([...newMessages, { from: "bot", text: safeReply }]);
    setTypingText("");
    setLoading(false);

    // Activar sÃ­ntesis de voz
    speak(safeReply);
  };

Â  const handleVoiceInput = () => {
Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  if (!SpeechRecognition) {
Â  Â  Â  alert("Tu navegador no soporta reconocimiento de voz ğŸ˜¢");
Â  Â  Â  return;
Â  Â  }

Â  Â  const recognition = new SpeechRecognition();
Â  Â  recognition.lang = "es-ES";
Â  Â  recognition.continuous = false;

Â  Â  recognition.onstart = () => setTypingText("ğŸ™ï¸ Escuchando...");
Â  Â  recognition.onresult = (event) => {
Â  Â  Â  const transcript = event.results[0][0].transcript;
Â  Â  Â  setTypingText("");
Â  Â  Â  setInput(transcript);
Â  Â  Â  handleSend(transcript);
Â  Â  };
Â  Â  recognition.onerror = () => {
Â  Â  Â  setTypingText("");
Â  Â  Â  alert("OcurriÃ³ un error al reconocer tu voz ğŸ˜¢");
Â  Â  };

Â  Â  recognition.start();
Â  };

Â  const preguntasSugeridas = [
Â  Â  "RecomiÃ©ndame lugares turÃ­sticos en Manizales",
Â  Â  "Â¿QuÃ© rutas puedo hacer para caminar y conocer la ciudad?",
Â  Â  "Sugiere restaurantes o comidas tÃ­picas de Manizales",
Â  Â  "Dime el clima actual y pronÃ³stico para hoy",
Â  Â  "Lugares para visitar con niÃ±os o familia",
Â  Â  "RecomiÃ©ndame cafÃ©s o lugares con buena vista",
Â  Â  "Actividades culturales o eventos en Manizales",
Â  Â  "Lugares para fotografÃ­a o paisajes",
Â  Â  "Planes econÃ³micos para turistas",
Â  Â  "Consejos para movilizarse por la ciudad",
Â  Â  "Recomendaciones para fines de semana",
Â  Â  "Rutas de senderismo cerca de Manizales",
Â  Â  "QuÃ© hacer en temporada de lluvias",
Â  Â  "Lugares histÃ³ricos e iglesias importantes",
Â  Â  "Eventos gastronÃ³micos o ferias locales"
Â  ];

Â  return (
Â  Â  <div
Â  Â  Â  style={{
Â  Â  Â  Â  height: "100vh",
Â  Â  Â  Â  width: "100vw",
Â  Â  Â  Â  display: "flex",
Â  Â  Â  Â  background: darkMode
Â  Â  Â  Â  Â  ? "linear-gradient(135deg, #232526,  #000000)" // Modo Oscuro: 
Â  Â  Â  Â  Â  : "linear-gradient(135deg, #E3F2FD, #BBDEFB)", // Modo Claro: A
Â  Â  Â  Â  fontFamily: "'Poppins', sans-serif",
Â  Â  Â  Â  padding: "30px",
Â  Â  Â  Â  boxSizing: "border-box",
Â  Â  Â  Â  gap: "30px",
Â  Â  Â  Â  transition: "0.5s ease"
Â  Â  Â  }}
Â  Â  >
Â  Â  Â  {/* PANEL IZQUIERDO */}
Â  Â  Â  <div
Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  width: "300px",
Â  Â  Â  Â  Â  background: "rgba(255, 255, 255, 0.7)", 
Â  Â  Â  Â  Â  borderRadius: "25px",
Â  Â  Â  Â  Â  padding: "20px",
Â  Â  Â  Â  Â  boxShadow: "0 8px 20px rgba(0,0,0,0.15)",
Â  Â  Â  Â  Â  display: "flex",
Â  Â  Â  Â  Â  flexDirection: "column",
Â  Â  Â  Â  Â  backdropFilter: "blur(10px)"
Â  Â  Â  Â  }}
Â  Â  Â  >
        <div style={{ textAlign: "center" }}>
          <img
            src="/MIZA.jpg"
            alt="MIZA"
            style={{ width: "150px", borderRadius: "50%", marginBottom: "10px", objectFit: "cover" }}
          />
          <h2 style={{ color: BLUE_ACCENT, fontSize: "24px", margin: 0 }}> MIZA GuÃ­a TurÃ­stica</h2>
        </div>Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  Â  flex: 1,
Â  Â  Â  Â  Â  Â  overflowY: "auto",
Â  Â  Â  Â  Â  Â  marginTop: "15px",
Â  Â  Â  Â  Â  Â  display: "flex",
Â  Â  Â  Â  Â  Â  flexDirection: "column",
Â  Â  Â  Â  Â  Â  gap: "10px"
Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  {preguntasSugeridas.map((p, i) => (
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  key={i}
Â  Â  Â  Â  Â  Â  Â  onClick={() => handleSend(p)}
Â  Â  Â  Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  Â  Â  Â  textAlign: "left",
Â  Â  Â  Â  Â  Â  Â  Â  padding: "12px",
Â  Â  Â  Â  Â  Â  Â  Â  borderRadius: "15px",
Â  Â  Â  Â  Â  Â  Â  Â  border: `2px solid ${BLUE_ACCENT}50`, // Borde azul claro
Â  Â  Â  Â  Â  Â  Â  Â  background: "rgba(255, 255, 255, 0.9)", // Fondo blanco claro
Â  Â  Â  Â  Â  Â  Â  Â  cursor: "pointer",
Â  Â  Â  Â  Â  Â  Â  Â  fontSize: "16px",
Â  Â  Â  Â  Â  Â  Â  Â  transition: "0.3s"
Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  {p}
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  onClick={() => setDarkMode(!darkMode)}
Â  Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  Â  marginTop: "15px",
Â  Â  Â  Â  Â  Â  padding: "10px",
Â  Â  Â  Â  Â  Â  borderRadius: "15px",
Â  Â  Â  Â  Â  Â  border: "none",
Â  Â  Â  Â  Â  Â  background: darkMode ? BLUE_ACCENT : "#f0f0f0", // BotÃ³n de Tema
Â  Â  Â  Â  Â  Â  color: darkMode ? "#fff" : BLUE_ACCENT,
Â  Â  Â  Â  Â  Â  fontSize: "16px",
Â  Â  Â  Â  Â  Â  cursor: "pointer"
Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Cambiar a {darkMode ? "â˜€ï¸ Claro" : "ğŸŒ™ Oscuro"}
Â  Â  Â  Â  </button>
Â  Â  Â  </div>

Â  Â  Â  {/* PANEL DERECHO */}
Â  Â  Â  <div
Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  flex: 1,
Â  Â  Â  Â  Â  background: "rgba(255, 255, 255, 0.7)", 
Â  Â  Â  Â  Â  borderRadius: "30px",
Â  Â  Â  Â  Â  padding: "25px",
Â  Â  Â  Â  Â  boxShadow: "0 10px 30px rgba(0,0,0,0.2)",
Â  Â  Â  Â  Â  display: "flex",
Â  Â  Â  Â  Â  flexDirection: "column",
Â  Â  Â  Â  Â  backdropFilter: "blur(10px)"
Â  Â  Â  Â  }}
Â  Â  Â  >
Â  Â  Â  Â  <h1 style={{ textAlign: "center", fontSize: "35px", color: BLUE_ACCENT }}>
Â  Â  Â  Â  Â   MIZA GuÃ­a TurÃ­stica
Â  Â  Â  Â  </h1>

Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  Â  flex: 1,
Â  Â  Â  Â  Â  Â  border: `3px solid ${BLUE_ACCENT}30`, 
Â  Â  Â  Â  Â  Â  borderRadius: "25px",
Â  Â  Â  Â  Â  Â  padding: "20px",
Â  Â  Â  Â  Â  Â  overflowY: "auto",
Â  Â  Â  Â  Â  Â  background: "rgba(255, 255, 255, 0.5)" 
Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  >
          {messages.map((msg, i) => (
            <div key={i} style={{ display: "flex", justifyContent: msg.from === "user" ? "flex-end" : "flex-start" }}>
              <div
                style={{
                  maxWidth: "70%",
                  padding: "15px 20px",
                  borderRadius: "20px",
                  background: msg.from === "user" ? "rgba(53, 114, 226, 0.15)" : "rgba(255, 255, 255, 0.9)" // Burbujas
                }}
              >
                <b>{msg.from === "user" ? "TÃº" : "MIZA"}:</b> {msg.text}
              </div>
            </div>
          ))}Â  Â  Â  Â  Â  {typingText && <div style={{ marginTop: "10px" }}>ğŸ“ {typingText}</div>}
Â  Â  Â  Â  </div>

Â  Â  Â  Â  {/* Input + Botones */}
Â  Â  Â  Â  <div style={{ marginTop: "20px", display: "flex", gap: "10px" }}>
Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  value={input}
Â  Â  Â  Â  Â  Â  onChange={(e) => setInput(e.target.value)}
Â  Â  Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  Â  Â  flex: 1,
Â  Â  Â  Â  Â  Â  Â  padding: "18px",
Â  Â  Â  Â  Â  Â  Â  borderRadius: "15px",
Â  Â  Â  Â  Â  Â  Â  border: `3px solid ${BLUE_ACCENT}50`, // Borde del Input
Â  Â  Â  Â  Â  Â  Â  fontSize: "18px"
Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  placeholder="Escribe tu pregunta sobre Manizales..."
Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={() => handleSend()}
Â  Â  Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  Â  Â  padding: "18px 25px",
Â  Â  Â  Â  Â  Â  Â  borderRadius: "15px",
Â  Â  Â  Â  Â  Â  Â  background: BLUE_ACCENT, // BotÃ³n Enviar
Â  Â  Â  Â  Â  Â  Â  color: "#fff",
Â  Â  Â  Â  Â  Â  Â  border: "none",
Â  Â  Â  Â  Â  Â  Â  fontSize: "18px",
Â  Â  Â  Â  Â  Â  Â  cursor: "pointer"
Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Enviar
Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  onClick={handleVoiceInput}
Â  Â  Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  Â  Â  padding: "18px",
Â  Â  Â  Â  Â  Â  Â  borderRadius: "15px",
Â  Â  Â  Â  Â  Â  Â  background: "#f0f8ff", // BotÃ³n Voz (Azul muy claro)
Â  Â  Â  Â  Â  Â  Â  border: "none",
Â  Â  Â  Â  Â  Â  Â  fontSize: "20px",
Â  Â  Â  Â  Â  Â  Â  cursor: "pointer"
Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  ğŸ¤
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
      </style>
Â  Â  </div>
Â  );
}